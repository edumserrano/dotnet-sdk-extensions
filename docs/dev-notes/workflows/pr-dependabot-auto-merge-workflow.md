# pr-dependabot-auto-merge worflows

[![PR Dependabot auto merge](https://github.com/edumserrano/dot-net-sdk-extensions/actions/workflows/pr-dependabot-auto-merge.yml/badge.svg)](https://github.com/edumserrano/dot-net-sdk-extensions/actions/workflows/pr-dependabot-auto-merge.yml)

The purpose of [this workflow](/.github/workflows/pr-dependabot-auto-merge.yml) is to auto merge pull requests generated by Dependabot.

This workflow is triggered once the `nuget-publish` workflow completes but will only execute if it was triggered by the `dependabot[bot]` actor. The flow is as follows:

1) Pull request generated.
2) `nuget-publish` workflow is triggered.
3) Once `nuget-publish` workflow completes, the `pr-dependabot-auto-merge` workflow is triggered.
4) If the actor **is not** `dependabot[bot]` then the workflow terminates. Else, it approves and merges the pull request.

Note that when the `pr-dependabot-auto-merge` is triggered, its actor will be the actor that triggered the `nuget-publish` workflow.

With this configuration the `pr-dependabot-auto-merge` workflow will only auto merge pull requests once the build has completed successfully and tests have passed. This is guaranteed by the `nuget-publish` workflow.

The [Dependabot configuration file](/.github/dependabot.yml) contains additional configuration for Dependabot.

## Conditions for auto-merge

Note that for pull requests to automatically be merged the conditions described in [Enable Auto-Merge for PR in Github Action](https://github.com/cli/cli/discussions/3660) must be met.

## Deleting branches from Dependabot pull requests

To be able to delete branches using the flag `--delete-branch` from [gh pr merge](https://cli.github.com/manual/gh_pr_merge), a checkout of the repo is done before or else the command fails because GitHub's CLI tries to delete both the remote and local branch.

**Without** the checkout step the `gh pr merge` command successfully deletes the remote branch, but it **fails to delete the local branch** and the workflow fails.

## Ignored NuGets

On the [Dependabot configuration file](/.github/dependabot.yml) the NuGet `Microsoft.AspNetCore.Mvc.Testing` is ignored because at the moment the `DotNet.Sdk.Extensions.Testing` project where the NuGet is used targets multiple target frameworks and has an `if condition` to use different NuGet versions depending on the target framework.

Dependabot does not know that handle this well and as such this NuGet needs to be manually updated for each target framework.

## Security considerations when setting up auto merge for Dependabot PRs

As per the [docs](https://docs.github.com/en/code-security/supply-chain-security/keeping-your-dependencies-updated-automatically/automating-dependabot-with-github-actions#responding-to-events):

> Dependabot is able to trigger GitHub Actions workflows on its pull requests and comments; however, due to ["GitHub Actions: Workflows triggered by Dependabot PRs will run with read-only permissions"](https://github.blog/changelog/2021-02-19-github-actions-workflows-triggered-by-dependabot-prs-will-run-with-read-only-permissions/), certain events are treated differently.
>
> For workflows initiated by Dependabot (github.actor == "dependabot[bot]") using the pull_request, pull_request_review, pull_request_review_comment, and push events, the following restrictions apply:
>
> - GITHUB_TOKEN has read-only permissions.
> - Secrets are inaccessible.
>

Given the above restrictions, the action to auto merge Dependabot PRs couldn't be done as part of the main `nuget-publish` workflow without potentially introducing security vulnerabilities.

As a result, the `dependabot-auto-merge-pr` workflow, which is responsible for merging a Dependabot PR, is a separate workflow that is [triggered from the completion of the main workflow](https://docs.github.com/en/actions/reference/events-that-trigger-workflows#workflow_run). **This workflow runs in a privileged workflow context which means that the `GITHUB_TOKEN` will have write permissions and be able to approve and merge the PR**.

For more information on keeping GitHub workflows secure see: [Security considerations on GitHub workflows](/docs/dev-notes/workflows/security-considerations.md)

## Fetch Metadata Action

The [dependabot/fetch-metadata](https://github.com/dependabot/fetch-metadata) can be used to extract information about the dependencies being updated by a Dependabot generated PR. The output from that action could be stored as a workflow artifact if the information is required by a priviliged workflow.
